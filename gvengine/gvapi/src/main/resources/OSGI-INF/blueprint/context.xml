<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0" 
			xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"		
    		xmlns:jaxrs="http://cxf.apache.org/blueprint/jaxrs"
    		xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 https://osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
    			http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd"	  			
	  			default-activation="eager">
	
	<reference-list id="securityManagerReferences" interface="it.greenvulcano.gvesb.iam.service.SecurityManager" 
			   		member-type="service-reference" availability="optional"/>
		
	<bean id="gvAuthenticationFilter" class="it.greenvulcano.gvesb.api.security.GVSecurityFilter">        
        <property name="gvSecurityManagerReferences" ref="securityManagerReferences"/>    
    </bean>

	<bean id="servicesController" class="it.greenvulcano.gvesb.api.controller.GvServicesControllerRest"/>
			
	<jaxrs:server address="/gvesb" id="gvesbapi">
        <jaxrs:serviceBeans>            
           <ref component-id="servicesController" />
        </jaxrs:serviceBeans> 
        <jaxrs:providers>
	       <ref component-id="gvAuthenticationFilter"/>
	    </jaxrs:providers>       
    </jaxrs:server>
    
    <reference id="gvSecurityManager" interface="it.greenvulcano.gvesb.iam.service.SecurityManager" activation="eager" availability="optional" timeout="500"/>
    
    <bean id="securityController" class="it.greenvulcano.gvesb.api.controller.GvSecurityControllerRest" init-method="init">
    	<property name="securityManager" ref="gvSecurityManager"/>
    </bean>
		
	<bean id="gviamAuthorizationInterceptor" class="org.apache.cxf.interceptor.security.SecureAnnotationsInterceptor">
   		<property name="allowAnonymousUsers" value="true" />
   		<property name="checkConfiguredRolesOnly" value="false" />
   		<property name="securedObject" ref="securityController"/>
	</bean>
	
	<bean id="gviamAuthorizationFilter" class="org.apache.cxf.jaxrs.security.SimpleAuthorizingFilter">	   
	   <property name="interceptor" ref="gviamAuthorizationInterceptor"/>
	</bean>	
			
	<jaxrs:server address="/gviam" id="gviamapi">
        <jaxrs:serviceBeans>            
           	<ref component-id="securityController" />
        </jaxrs:serviceBeans> 
        <jaxrs:providers>
	       	<ref component-id="gvAuthenticationFilter"/>
	       	<ref component-id="gviamAuthorizationFilter"/>	     
	    </jaxrs:providers>       
    </jaxrs:server>
        
</blueprint>