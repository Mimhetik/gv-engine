<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
	xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:cxf="http://cxf.apache.org/blueprint/core"
	xmlns:jaxrs="http://cxf.apache.org/blueprint/jaxrs"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 https://osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
    			http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd
	  			http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd
	  			http://cxf.apache.org/blueprint/core http://cxf.apache.org/schemas/blueprint/core.xsd
	  			http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0  http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.1.0.xsd"
	default-activation="eager">


	<bean id="consoleServicesController"
		  class="it.greenvulcano.gvesb.console.api.controller.GvConsoleServicesControllerRest">
	   <property name="serviceInstanceRepo" ref="serviceInstanceDao" />
	   <property name="traceLevelServiceRepo" ref="traceLevelServiceDao" />
	</bean>

	<jaxrs:server address="/gvconsoleapi" id="gvConsoleServicesController">
		<jaxrs:providers>
        	<bean class="org.codehaus.jackson.jaxrs.JacksonJsonProvider">
            	<property name="mapper" ref="jacksonMapper" />
        	</bean>
    	</jaxrs:providers>
		<jaxrs:serviceBeans>
			<ref component-id="consoleServicesController" />
		</jaxrs:serviceBeans>
	</jaxrs:server>
	 
	<bean id="jacksonMapper" class="org.codehaus.jackson.map.ObjectMapper">
	</bean>
	
	<!-- TODO <cm:property-placeholder persistent-id="io.modio.blog.osgi.morphia" /> -->

    <cm:property-placeholder persistent-id="it.greenvulcano.gvesb.console" update-strategy="reload" >
			<cm:default-properties>
				<cm:property name="gvconsole.mongo.host" value="127.0.0.1" />				
				<cm:property name="gvconsole.mongo.port" value="27017" />
				<cm:property name="gvconsole.mongo.dbname" value="console_db" />
			</cm:default-properties>
	</cm:property-placeholder>

	<bean id="mongoClient" class="com.mongodb.MongoClient">
		<!-- <argument value="${io.modio.blog.osgi.morphia.mongodb.host}" />
		<argument value="${io.modio.blog.osgi.morphia.mongodb.port}" /> -->
		<argument value="${gvconsole.mongo.host}" />
		<argument value="${gvconsole.mongo.port}" />
	</bean>

	<bean id="morphiaFactory" class="it.greenvulcano.gvesb.console.api.repository.MorphiaFactory">
		<property name="bContext" ref="blueprintBundleContext" />
		<property name="classes">
			<list>
				<value>it.greenvulcano.gvesb.console.api.model.ServiceInstance</value>
				<value>it.greenvulcano.gvesb.console.api.model.TraceLevelService</value>
			</list>
		</property>
	</bean>
	<bean id="morphia" factory-ref="morphiaFactory" factory-method="get" />

	<bean id="datastoreFactory" class="it.greenvulcano.gvesb.console.api.repository.DatastoreFactory">
		<property name="mongoClient" ref="mongoClient" />
		<property name="morphia" ref="morphia" />
		<!-- <property name="database" value="${io.modio.blog.osgi.morphia.mongodb.db}" /> -->
		<property name="database" value="${gvconsole.mongo.dbname}" />
	</bean>
	<bean id="datastore" factory-ref="datastoreFactory" factory-method="get" />

    <!-- implemenation of the service -->
	<!-- DAOs -->
	<bean id="serviceInstanceDao" class="it.greenvulcano.gvesb.console.api.repository.dao.ServiceInstanceDaoImpl">
		<argument ref="datastore" />
	</bean>
	<bean id="traceLevelServiceDao" class="it.greenvulcano.gvesb.console.api.repository.dao.TraceLevelServiceDaoImpl">
		<argument ref="datastore" />
	</bean>

	<!-- Services -->
	<!-- <service ref="aclDao" interface="io.modio.blog.osgi.morphia.dao.AclDao" />
	<service ref="principalDao" interface="io.modio.blog.osgi.morphia.dao.PrincipalDao" /> -->
	
	
	<!-- create a service with the implementation -->
	<service id="serviceInstanceService" ref="serviceInstanceDao"   interface="it.greenvulcano.gvesb.console.api.repository.dao.ServiceInstanceDao" />
	<service id="traceLevelService"      ref="traceLevelServiceDao" interface="it.greenvulcano.gvesb.console.api.repository.dao.TraceLevelServiceDao" />

	 
	<!-- <reference id="serviceInstanceServiceRef" interface="it.greenvulcano.gvesb.console.api.repository.dao.ServiceInstanceDao" activation="eager" />
	 --> 
	<!-- <bean id="serviceInstance"   ref="serviceInstanceDao"   interface="it.greenvulcano.gvesb.console.api.repository.dao.ServiceInstanceDao" />
	<bean id="traceLevelService" ref="traceLevelServiceDao" interface="it.greenvulcano.gvesb.console.api.repository.dao.TraceLevelServiceDao" />
 -->

</blueprint>